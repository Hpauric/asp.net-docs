<!doctype html>
<html>
  <head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
 <link href="images/favicon.ico" rel="icon" type="image/ico" />    
<title>ASP.NET Reference</title>

<style>
  .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
</style>
<link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
<link href="stylesheets/print.css" rel="stylesheet" media="print" />
  <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[]">
<a href="#" id="nav-button">
  <span>
NAV
<img src="images/navbar.png" alt="Navbar" />
  </span>
</a>
<div class="tocify-wrapper">
  <img src="images/logo.png" alt="Logo" />
<div class="search">
  <input type="text" class="search" id="input-search" placeholder="Search">
</div>
<ul class="search-results"></ul>
  <div id="toc">
  </div>
<ul class="toc-footer">
<li><a href='https://docs.microsoft.com/en-us/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/'>EF6 Code First</a></li>
<li><a href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
</ul>
</div>
<div class="page-wrapper">
  <div class="dark-box"></div>
  <div class="content">
<h1 id="c-basics">C# Basics</h1>

<h2 id="attributes">Attributes</h2>

<p>Attributes are effectively metadata that describe the property, method or class that they precede. They are encased in square brackets.</p>
<pre class="highlight csharp tab-csharp"><code><span class="na">[Display(Name = "Release Date")]</span> <span class="c1">// attribute</span>
<span class="k">public</span> <span class="n">DateTime</span> <span class="n">ReleaseDate</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre>
<h2 id="get-set-auto-property"><code class="prettyprint">{get; set;}</code> auto-property</h2>

<p><a href="https://stackoverflow.com/questions/5096926/what-is-the-get-set-syntax-in-c">Stack Overflow</a>
It&rsquo;s a so-called auto property, and is essentially a shorthand for the following (similar code will be generated by the compiler):</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">private</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span>
<span class="p">{</span>
    <span class="k">get</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">set</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h2 id="generics">Generics</h2>

<p>Generics can be classes or structs. Type-parameters are names used in place of concrete types when defining a new generic. They can be associated with classes or methods by placing the type parameter in angle brackets <code class="prettyprint">&lt; &gt;</code>.</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="c1">// T stands for type</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="p">}</span>
<span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
<span class="n">List</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;();</span>
<span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;();</span>
</code></pre>
<h2 id="asp-net-classes-cheatsheet">ASP.NET Classes Cheatsheet</h2>

<h3 id="some-useful-classes">Some Useful Classes</h3>

<ul>
<li>IEnumerable <code class="prettyprint">System.Collections.Generic</code></li>
<li>DbContext <code class="prettyprint">System.Data.Entity</code></li>
<li>Controller <code class="prettyprint">System.Web.Mvc</code></li>
<li>HTMLHelper <code class="prettyprint">System.Web.Mvc</code></li>
</ul>

<h1 id="entity-framework">Entity Framework</h1>

<p>Why do we need Entity Framework?
You can use Entity Framework for code-first implementations. This allows you to define your models in code, and let Entity Framework generate the database for you.</p>

<h2 id="using-entity-framework">Using Entity Framework</h2>

<p>The main class that coordinates Entity Framework functionality for a given data model is the database context class. You create this class by deriving from the <code class="prettyprint">System.Data.Entity.DbContext</code> class. In your code you specify which entities are included in the data model.</p>

<h2 id="asp-net-set-model-field-cascade-null">asp.net set model field cascade null</h2>

<p>There are a few options if you want to set a model field to cascade set null.</p>

<p>You can use the ModelBuilder</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">DbModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Conventions</span><span class="p">.</span><span class="n">Remove</span><span class="p">&lt;</span><span class="n">PluralizingTableNameConvention</span><span class="p">&gt;();</span>

            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">Equipment</span><span class="p">&gt;()</span>
                <span class="p">.</span><span class="n">HasOptional</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Student</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">WithMany</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">HasForeignKey</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">StudentID</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">WillCascadeOnDelete</span><span class="p">();</span>
</code></pre>
<p>Or you can use migrations</p>

<p>https://stackoverflow.com/questions/46804386/ef-code-first-cascade-null</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">AddOnDeleteSetNull</span> <span class="p">:</span> <span class="n">DbMigration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Up</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">Sql</span><span class="p">(</span><span class="s">"ALTER TABLE dbo.TableA DROP CONSTRAINT [FK_dbo.TableA_dbo.Users_UserModifiedId]"</span><span class="p">);</span>
        <span class="nf">Sql</span><span class="p">(</span><span class="s">"ALTER TABLE dbo.TableA ADD CONSTRAINT [FK_dbo.TableA_dbo.Users_UserModifiedId_SetNullOnDelete] FOREIGN KEY (UserModifiedId) REFERENCES dbo.Users(UserId) ON UPDATE NO ACTION ON DELETE SET NULL"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Down</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Here you have to undo the changes!</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h2 id="the-dbcontext-class">The <code class="prettyprint">DbContext</code> class</h2>

<p><code class="prettyprint">DbContext</code> allows you to interact with the database that Entity Framework creates.</p>

<p>For example</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">private</span> <span class="n">ProjectContext</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProjectContext</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">equipments</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Equipments</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Student</span><span class="p">);</span>
</code></pre>
<p>returns an <code class="prettyprint">IQueryable&lt;Equipment&gt;</code> array of objects.</p>

<p>The <code class="prettyprint">DbContext</code> class you create will usually be quite simple.</p>
<pre class="highlight csharp tab-csharp"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">ProjectContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>

        <span class="k">public</span> <span class="nf">ProjectContext</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="s">"ProjectContext"</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;</span> <span class="n">Students</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Equipment</span><span class="p">&gt;</span> <span class="n">Equipments</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">DbModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Conventions</span><span class="p">.</span><span class="n">Remove</span><span class="p">&lt;</span><span class="n">PluralizingTableNameConvention</span><span class="p">&gt;();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
<h3 id="dbcontext-methods">DbContext Methods</h3>

<h2 id="creating-the-schema">Creating the Schema</h2>

<p>If you look at the example application Microsoft use to demonstrate the features, you&rsquo;ll see that in the first excercise they create three entities:
- Student
- Course
- Enrollment</p>

<p>If you were creating your first application you might think you would just need two entities: <code class="prettyprint">Student</code> and <code class="prettyprint">Course</code>. Why do we need Enrollment? Why can&rsquo;t our Students have the course they are enrolled in as properties, and our Course have Students as properties? What does the <code class="prettyprint">Enrollment</code> entity bring to the table?</p>

<blockquote>
<p>The many-to-many relationship involves defining a third table (called a junction or join table), whose primary key is composed of the foreign keys from both related tables. </p>
</blockquote>

<p>Is this true for the Enrollment entity? No. It has it&rsquo;s own EnrollmentID key.</p>

<h2 id="navigation-properties">Navigation Properties</h2>

<blockquote>
<p>Navigation properties provide a way to navigate an association between two entity types. Every object can have a navigation property for every relationship in which it participates. Navigation properties allow you to navigate and manage relationships in both directions, returning either a reference object (if the multiplicity is either one or zero-or-one) or a collection (if the multiplicity is many). You may also choose to have one-way navigation, in which case you define the navigation property on only one of the types that participates in the relationship and not on both.</p>
</blockquote>

<p>https://msdn.microsoft.com/en-us/library/jj713564(v=vs.113).aspx</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">public</span> <span class="k">virtual</span> <span class="n">OfficeAssignment</span> <span class="n">OfficeAssignment</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre>
<p>If a navigation property can hold multiple entities, its type must implement the ICollection<T> Interface.</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">public</span> <span class="k">virtual</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">Equipment</span><span class="p">&gt;</span> <span class="n">Equipment</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  
</code></pre>
<p>The <code class="prettyprint">Equipment</code> property is a navigation property. Navigation properties hold other entities that are related to this entity. In this case, the <code class="prettyprint">Equipment</code> property of a <code class="prettyprint">Student</code> entity will hold all of the <code class="prettyprint">Equipment</code> entities that are related to that Student entity. In other words, if a given <code class="prettyprint">Student</code> row in the database has two related <code class="prettyprint">Equipment</code> rows (rows that contain that student&rsquo;s primary key value in their StudentID foreign key column), that <code class="prettyprint">Student</code> entity&rsquo;s <code class="prettyprint">Equipment</code> navigation property will contain those two <code class="prettyprint">Equipment</code> entities.</p>

<p>Navigation properties are typically defined as virtual so that they can take advantage of an Entity Framework feature called lazy loading.</p>

<h2 id="lazy-loading-eager-loading-and-explicit-loading">Lazy Loading, Eager Loading and Explicit Loading</h2>

<blockquote>
<p>There are several ways that the Entity Framework can load related data into the navigation properties of an entity:</p>

<p>Lazy loading. When the entity is first read, related data isn&rsquo;t retrieved. However, the first time you attempt to access a navigation property, the data required for that navigation property is automatically retrieved. This results in multiple queries sent to the database — one for the entity itself and one each time that related data for the entity must be retrieved. The DbContext class enables lazy loading by default.</p>

<p>Eager loading. When the entity is read, related data is retrieved along with it. This typically results in a single join query that retrieves all of the data that&rsquo;s needed. You specify eager loading by using the Include method.</p>
</blockquote>

<h3 id="explicit-loading">Explicit loading</h3>

<p>This is similar to lazy loading, except that you explicitly retrieve the related data in code; it doesn&rsquo;t happen automatically when you access a navigation property. You load related data manually by getting the object state manager entry for an entity and calling the <code class="prettyprint">Collection.Load</code> method for collections or the <code class="prettyprint">Reference.Load</code> method for properties that hold a single entity. If you wanted to load Courses:</p>
<pre class="highlight csharp tab-csharp"><code><span class="nf">Collection</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Courses</span><span class="p">)</span>
</code></pre>
<p>If you wanted to load the Administrator navigation property, you&rsquo;d would instead use:</p>
<pre class="highlight csharp tab-csharp"><code><span class="nf">Reference</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Administrator</span><span class="p">).)</span> <span class="n">T</span>
</code></pre>
<p>Typically you&rsquo;d use explicit loading only when you&rsquo;ve turned lazy loading off.</p>

<blockquote>
<p>Because they don&rsquo;t immediately retrieve the property values, lazy loading and explicit loading are also both known as deferred loading.</p>
</blockquote>

<p>Interestingly, lazy loading is not yet included in Entity Framework Core (2.0). This might be because it&rsquo;s hard to implement, or it might be because the EF Core team don&rsquo;t think highly of lazy loading.</p>

<h2 id="code-first">Code First</h2>

<p>Entity Framework allows you to develop a data model with a Code First approach.</p>

<p>This means that you can define your models and Entity Framework will create the database for you.</p>

<h2 id="the-connection-string">The Connection String</h2>

<p>A connection string provides the information that a provider needs to communicate with a particular database. The Connection String includes parameters such as the name of the driver, Server name and Database name , as well as security information such as user name and password.</p>

<p>Enter this text in the <code class="prettyprint">Web.config</code> file in your project.</p>
<pre class="highlight html tab-html"><code><span class="nt">&lt;connectionStrings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"[YOURMODELNAMEHERE]Context"</span>    
         <span class="na">connectionString=</span><span class="s">"Data Source=(LocalDB)\MSSQLLocalDB;
  AttachDbFilename=|DataDirectory|\[YOURDATABASENAMEHERE].mdf;
  Integrated Security=True"</span> 
         <span class="na">providerName=</span><span class="s">"System.Data.SqlClient"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/connectionStrings&gt;</span>
</code></pre>
<p>You don&rsquo;t actually have to have a connection string in the <code class="prettyprint">Web.config</code> file. If you don&rsquo;t supply a connection string, Entity Framework will use a default one based on your context class. However in that case the data won&rsquo;t save to a database.</p>

<p>Note that In Visual Studio 2012 the data source is <code class="prettyprint">(LocalDB)\v11.0</code>. For Visual Studio 2015 and Visual Studio 2017 it is <code class="prettyprint">(LocalDB)\MSSQLLocalDB</code>.
<code class="prettyprint">LocalDB</code> is a lightweight version of the SQL Server Express Database Engine that is targeted for program development. <code class="prettyprint">LocalDB</code> starts on demand and runs in user mode, so there is no complex configuration. </p>

<h3 id="deploying-to-azure">Deploying to Azure</h3>

<p>New connection strings are generated when you deploy to Azure.</p>
<pre class="highlight html tab-html"><code><span class="nt">&lt;connectionStrings&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"ProjectContext"</span>
    <span class="na">connectionString=</span><span class="s">"$(ReplacableToken_ProjectContext-Web.config Connection String_0)"</span>
    <span class="na">providerName=</span><span class="s">"System.Data.SqlClient"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"ProjectContext_DatabasePublish"</span>
    <span class="na">connectionString=</span><span class="s">"$(ReplacableToken_ProjectContext_DatabasePublish-Web.config Connection String_0)"</span>
    <span class="na">providerName=</span><span class="s">"System.Data.SqlClient"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/connectionStrings&gt;</span>
</code></pre>
<p>You can find them in <code class="prettyprint">[ProjectName]\obj\Release\Package\PackageTmp\Web.config</code>.</p>

<h2 id="drop-and-recreate-databases">Drop and Recreate Databases</h2>

<blockquote>
<p>The Entity Framework can automatically create (or drop and re-create) a database for you when the application runs. You can specify that this should be done every time your application runs or only when the model is out of sync with the existing database. You can also write a Seed method that the Entity Framework automatically calls after creating the database in order to populate it with test data. - <a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application#set-up-ef-to-initialize-the-database-with-test-data">Set up EF to initialize the database with test data</a></p>
</blockquote>

<h2 id="migrations">Migrations</h2>

<p>Code First Migrations allow you to update your data model and update the database schema without having to drop and re-create the database.</p>

<p>You don&rsquo;t <em>have</em> to use Migrations. However, if you don&rsquo;t, all database content will be lost when you update your models.</p>

<p><a href="https://stackoverflow.com/questions/40606167/error-when-update-database-using-code-first-there-is-already-an-object-named">Great introduction to Code First Migrations</a></p>

<h2 id="the-dropcreatedatabaseifmodelchanges-class">The <code class="prettyprint">DropCreateDatabaseIfModelChanges</code> Class</h2>

<p>You can create a <code class="prettyprint">DropCreateDatabaseIfModelChanges</code> class in the same folder as your <code class="prettyprint">DbContext</code> class that will specify what will happen when your model changes.</p>
<pre class="highlight csharp tab-csharp"><code> <span class="k">public</span> <span class="k">class</span> <span class="err">[</span><span class="nc">YourInitializer</span><span class="p">]:</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">DropCreateDatabaseIfModelChanges</span><span class="k">&lt;[</span><span class="n">YourContext</span><span class="k">]&gt;</span>
    <span class="p">{</span>
</code></pre>
<p>To tell Entity Framework to use your initializer class, add an element to the <code class="prettyprint">entityFramework</code> element in the application <code class="prettyprint">Web.config</code> file (the one in the root project folder):</p>
<pre class="highlight html tab-html"><code><span class="nt">&lt;entityFramework&gt;</span>
  <span class="nt">&lt;contexts&gt;</span>
    <span class="nt">&lt;context</span> <span class="na">type=</span><span class="s">"ContosoUniversity.DAL.SchoolContext, ContosoUniversity"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;databaseInitializer</span> <span class="na">type=</span><span class="s">"ContosoUniversity.DAL.SchoolInitializer, ContosoUniversity"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/context&gt;</span>
  <span class="nt">&lt;/contexts&gt;</span>
  ...
</code></pre>
<h2 id="the-dbmigrationsconfiguration-class">The <code class="prettyprint">DbMigrationsConfiguration</code> Class</h2>

<p>The <code class="prettyprint">DbMigrationsConfiguration</code> class has its own <code class="prettyprint">Seed</code> method that will run every time the <code class="prettyprint">Update-Database</code> Powershell command is executed, even if there is no explicit pending migration. This is in contrast to the Database initializer <code class="prettyprint">Seed</code> method, which will only run when the database is created. <a href="https://blog.oneunicorn.com/2013/05/28/database-initializer-and-migrations-seed-methods">Database initializer and Migrations Seed methods</a> is a great blog post that covers this in more detail.</p>

<p>It must handle cases where the database already contains data because Migrations is evolving the database rather than dropping and recreating it. For this reason, the <code class="prettyprint">AddOrUpdate</code> extension method is used in the migration Seed method.</p>

<p>You&rsquo;ll need to disable the database initializer by commenting out or deleting the <code class="prettyprint">&lt;databaseInitializer&gt;</code> element you added in the <code class="prettyprint">Web.config</code> file.</p>

<h2 id="nuget-commands">NuGet Commands</h2>

<p>There are three main NuGet commands used in migrations.</p>

<table><thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">Enable-Migrations</code></td>
<td>Install migration modules - only needs to be run initially</td>
</tr>
<tr>
<td><code class="prettyprint">Add-Migration [MigrationName]</code></td>
<td>Generate a new migration code file based on changes in your project models</td>
</tr>
<tr>
<td><code class="prettyprint">Update-Database</code></td>
<td>Implement any outstanding migrations</td>
</tr>
</tbody></table>

<p>Migrations are code files. Every time you run <code class="prettyprint">Add-Migration</code> a code file is generated/updated, usually in a folder called <code class="prettyprint">Migrations</code> inside your project. The name of a migration file is composed with a timestamp of its generation concatenated with the name used when running <code class="prettyprint">Add-Migration</code>. For example
<code class="prettyprint">bash
Add-Migration Initial
</code>
generates
<code class="prettyprint">bash
201710021217244_Initial.cs
</code>
You can check the contents of those files and see the effects of running <code class="prettyprint">Add-Migration</code>. You can also modify them once generated, and add your own code. From my experience it is often necessary to do this.</p>

<h2 id="up-and-down-methods">Up and Down Methods</h2>

<p>Every single migration has a method <code class="prettyprint">Up</code> and a method <code class="prettyprint">Down</code>. </p>

<p>The <code class="prettyprint">Up</code> method updates the database. The <code class="prettyprint">Down</code> method reverts them.</p>

<p>Methods:</p>

<ul>
<li><code class="prettyprint">CreateTable</code>&nbsp;</li>
<li><code class="prettyprint">CreateIndex</code>&nbsp;</li>
<li><code class="prettyprint">AlterColumn</code>&nbsp;</li>
<li><code class="prettyprint">AddForeignKey</code>&nbsp;</li>
<li><code class="prettyprint">DropTable</code>&nbsp;</li>
<li><code class="prettyprint">DropIndex</code>&nbsp;</li>
<li><code class="prettyprint">DropForeignKey</code>&nbsp;</li>
</ul>

<h2 id="the-configuration-file">The Configuration File</h2>

<p>This is where you set the <code class="prettyprint">Seed</code> method, as well as methods that run every time you have a migration.</p>

<h2 id="setting-the-seed-method-to-update-from-a-csv-file">Setting the <code class="prettyprint">Seed</code> method to update from a csv file.</h2>

<p>Rather than painstakingly typing values into the Seed method, you can set it to import from a CSV file.
<a href="https://www.davepaquette.com/archive/2014/03/18/seeding-entity-framework-database-from-csv.aspx">There are great instructions on how to do this here.</a>
One mistake I made at first was that I referenced the wrong assembly. Stack Overflow recommended &ldquo;to make sure you&rsquo;re in the right assembly and with right name: dump and evaluate all the resources available in your target assembly.&rdquo; Which I did:</p>
<pre class="highlight csharp tab-csharp"><code><span class="kt">string</span><span class="p">[]</span> <span class="n">names</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="nf">GetManifestResourceNames</span><span class="p">();</span>
<span class="kt">string</span> <span class="n">fullString</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
<span class="n">names</span><span class="p">.</span><span class="nf">ToList</span><span class="p">().</span><span class="nf">ForEach</span><span class="p">(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">fullString</span> <span class="p">+=</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="nf">ToString</span><span class="p">())</span> <span class="p">+</span> <span class="sc">'\n'</span><span class="p">);</span>
</code></pre>
<h2 id="migration-history">Migration History</h2>

<p>Migrations are intended to be incremental. You start with an <code class="prettyprint">Initial</code> migration, and every time you change your model code you generate a new migration file. For example, <code class="prettyprint">201712121451507_type-correction-date-purchased.cs</code>. The database contains a table named <code class="prettyprint">__MigrationsHistory</code> that keeps trace of which migrations have been run in your database.</p>

<p>When you run <code class="prettyprint">Update-Database</code> there are always two implicit parameters: <code class="prettyprint">SourceMigration</code> and <code class="prettyprint">TargetMigration</code>. EF incrementally applies the <code class="prettyprint">Up</code> methods of all the migrations between <code class="prettyprint">SourceMigration</code> and <code class="prettyprint">TargetMigration</code> (or the <code class="prettyprint">Down</code> methods if you are downgrading your database). </p>

<p>The default scenario when you don&rsquo;t specify the <code class="prettyprint">SourceMigration</code> and <code class="prettyprint">TargetMigration</code> parameters is that <code class="prettyprint">SourceMigration</code> is the last migration applied to the database and <code class="prettyprint">TargetMigration</code> is the last of the pending ones. EF determines those parameters by querying the <code class="prettyprint">__MigrationsHistory</code> table of the default database of your project, so if that database is not in a consistent state, your migrations can be generated incorrectly.</p>

<h2 id="when-things-go-wrong">When Things Go Wrong</h2>

<p>Entity Framework is not perfect.</p>

<blockquote>
<p>Essentially the ORM can handle about 80-90% of the mapping problems, but that last chunk always needs careful work by somebody who really understands how a relational database works.</p>

<p>Mapping to a relational database involves lots of repetitive, boiler-plate code. A framework that allows me to avoid 80% of that is worthwhile even if it is only 80%. The problem is in me for pretending it&rsquo;s 100% when it isn&rsquo;t.</p>
</blockquote>

<p>You can&rsquo;t just run <code class="prettyprint">Add-Migration MyNewMigration</code> and assume everything will work out fine. You need to check to make sure that the generated code works correctly.</p>

<h3 id="debugging-the-update-database-command">Debugging the <code class="prettyprint">Update-Database</code> command</h3>

<p>Running the <code class="prettyprint">Update-Database</code> command meant that debugging statments like <code class="prettyprint">Debug.WriteLine()</code> didn&rsquo;t work. Instead I threw an error:</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="n">fullString</span><span class="p">);</span>
</code></pre>
<p>Then I could see I couldn&rsquo;t access the resource since:</p>

<ol>
<li>It was saved in the wrong namespace.&nbsp;</li>
<li>It&rsquo;s build action was set to <code class="prettyprint">Resource</code> instead of <code class="prettyprint">Embedded Resource</code>.&nbsp;</li>
</ol>

<p>After I fixed these mistakes I could easily Seed from a CSV.</p>

<h3 id="erasing-everything-the-easiest-way-to-fix-a-problem">Erasing Everything - The Easiest Way to Fix a Problem</h3>

<p>You can simply delete the database and migrations history. Obviously this is not a viable solution for production code, but it&rsquo;s often the easiest solution for development code.</p>

<ol>
<li>Delete the <code class="prettyprint">Migrations</code> folder in your solution.</li>
<li>Delete the tables in the database.</li>
<li>Delete the <code class="prettyprint">_MigrationHistory</code> table in the database.</li>
<li>Close the database connection.</li>
<li>In the NuGet console, run <code class="prettyprint">Enable-Migrations</code>.</li>
<li>Run <code class="prettyprint">Add-Migration Initial</code>.</li>
<li>Run <code class="prettyprint">Update-Database</code>.</li>
</ol>

<h2 id="errors">Errors</h2>

<h3 id="error-there-is-already-an-object-named-modelname-in-the-database">Error: <code class="prettyprint">There is already an object named &#39;ModelName&#39; in the database.</code></h3>

<h3 id="error-sequence-contains-more-than-one-element">Error: <code class="prettyprint">Sequence contains more than one element.</code></h3>

<p>https://docs.microsoft.com/en-us/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application#enable-code-first-migrations</p>

<p>The first parameter passed to the AddOrUpdate method specifies the property to use to check if a row already exists. For the test student data that you are providing, the LastName property can be used for this purpose since each last name in the list is unique:
C#Copy
context.Students.AddOrUpdate(p =&gt; p.LastName, s)</p>

<p>This code assumes that last names are unique. If you manually add a student with a duplicate last name, you&rsquo;ll get the following exception the next time you perform a migration.
Sequence contains more than one element</p>

<p>https://blogs.msdn.microsoft.com/rickandy/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs/</p>

<p>So it was a Seed error. But it doesn’t cause any big problems. It just means I can’t add the extra data. That’s not a problem, is it?</p>

<h1 id="views">Views</h1>

<h2 id="using-code">Using Code</h2>

<blockquote>
<p>The key transition character in Razor is the “at” sign (@). This single character is used to transition from markup to code.</p>
</blockquote>

<p>The <code class="prettyprint">@</code> transition symbol effectively works as a <code class="prettyprint">console.log</code> or <code class="prettyprint">println()</code> mechanism.</p>

<p>Code that is encased in curly brackets will be executed. Code that&rsquo;s simply preceded by <code class="prettyprint">@</code> will be outputted.</p>
<pre class="highlight python tab-python"><code><span class="err">@</span><span class="p">{</span><span class="n">var</span> <span class="n">test</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="p">}</span>
<span class="err">@</span><span class="p">{</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
<span class="nd">@test</span> <span class="o">//</span> <span class="mi">9</span>
</code></pre>
<p>By including a @model statement at the top of the view template file, you can specify the type of object that the view expects.</p>

<p><code class="prettyprint">@model IEnumerable&lt;Your.Model.Namespace&gt;</code></p>

<p>This <code class="prettyprint">@model</code> directive allows you to access the list of movies that the controller passed to the view</p>

<h2 id="layout">Layout</h2>

<p>By convention, the default layout for an ASP.NET app is named <code class="prettyprint">_Layout.cshtml</code>.</p>

<p>The default layout is defined in <code class="prettyprint">_ViewStart.cshtml</code> file in <code class="prettyprint">Views</code>.</p>

<h2 id="the-viewbag-object">The Viewbag Object</h2>

<p>The <code class="prettyprint">Viewbag</code> object allows you to share properties from the controller to the View.</p>

<blockquote>
<p>ViewBag can be useful when you want to transfer temporary data (which is not included in model) from the controller to the view. The viewBag is a dynamic type property of ControllerBase class which is the base class of all the controllers.</p>
</blockquote>

<p>This code below is generated by the scaffolding.</p>

<p>In the controller:</p>
<pre class="highlight csharp tab-csharp"><code><span class="n">ViewBag</span><span class="p">.</span><span class="n">StudentID</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SelectList</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Students</span><span class="p">,</span> <span class="s">"StudentID"</span><span class="p">,</span> <span class="s">"StudentID"</span><span class="p">);</span>
</code></pre>
<p>In the view:</p>
<pre class="highlight csharp tab-csharp"><code><span class="n">Html</span><span class="p">.</span><span class="nf">DropDownList</span><span class="p">(</span><span class="s">"StudentID"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">htmlAttributes</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">@class</span> <span class="p">=</span> <span class="s">"form-control"</span> <span class="p">})</span>
</code></pre>
<h2 id="html-helper-methods">HTML Helper Methods</h2>

<p>The <code class="prettyprint">Html</code> object is a helper that&rsquo;s exposed using a property on the <code class="prettyprint">System.Web.Mvc.WebViewPage</code> base class. </p>

<h3 id="html-beginform"><code class="prettyprint">Html.BeginForm</code></h3>

<p>if you leave it empty it will look for a post action with the same name that on the page you are now</p>

<ul>
<li><code class="prettyprint">Html.DisplayNameFor</code></li>
<li><code class="prettyprint">Html.DisplayFor</code></li>
<li><code class="prettyprint">Html.ValidationSummary</code></li>
<li><code class="prettyprint">Html.EditorFor</code></li>
<li><code class="prettyprint">Html.LabelFor</code></li>
<li><code class="prettyprint">Html.DropDownList</code></li>
</ul>

<h3 id="html-actionlink"><code class="prettyprint">Html.ActionLink</code></h3>

<p>The <code class="prettyprint">ActionLink</code> method of the helper makes it easy to dynamically generate HTML hyperlinks that link to action methods on controllers. </p>
<pre class="highlight csharp tab-csharp"><code><span class="n">@Html</span><span class="p">.</span><span class="nf">ActionLink</span><span class="p">(</span><span class="s">"Edit"</span><span class="p">,</span> <span class="s">"Edit"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span><span class="p">=</span><span class="n">item</span><span class="p">.</span><span class="n">ID</span> <span class="p">})</span> 
</code></pre>
<h4 id="arguments">Arguments</h4>

<table><thead>
<tr>
<th>Type</th>
<th>Name</th>
</tr>
</thead><tbody>
<tr>
<td>string</td>
<td>linkText</td>
</tr>
<tr>
<td>string</td>
<td>actionName (this is the method name unless otherwise specified)</td>
</tr>
<tr>
<td>string OR object</td>
<td>controllerName OR routeValues</td>
</tr>
</tbody></table>

<p>The default route (established in <code class="prettyprint">App_Start\RouteConfig.cs)</code> takes the URL pattern <code class="prettyprint">{controller}/{action}/{id}</code></p>

<p>So for example,the generated route in this case is <code class="prettyprint">http://localhost:1234/Movies/Edit/4</code></p>

<h3 id="html-displayfor"><code class="prettyprint">Html.DisplayFor</code></h3>

<h2 id="datatables">DataTables</h2>

<p>Datatables is a great JQuery Library</p>

<h2 id="how-to-display-a-field-date-value-that-might-be-null">How to display a field date value that might be null</h2>
<pre class="highlight html tab-html"><code>@if (item.DateAssigned.HasValue)
                {
                    @item.DateAssigned.Value.ToString("MM/dd/yyyy")
                }
</code></pre>
<h1 id="controllers">Controllers</h1>

<p>Rather than having a direct relationship between the URL and a file living on the web server’s hard
drive, a relationship exists between the URL and a method on a controller class</p>

<p>AccountController: Responsible for account-related requests, such as login and account
registration</p>

<p>A controller can pass data or objects to a view template using the <code class="prettyprint">ViewBag</code> object. The <code class="prettyprint">ViewBag</code> is a dynamic object that provides a convenient late-bound way to pass information to a view.</p>

<h2 id="creating-a-bulkcreate-method">Creating a <code class="prettyprint">BulkCreate</code> method</h2>

<p>https://docs.microsoft.com/en-us/aspnet/mvc/overview/getting-started/introduction/adding-a-view</p>

<blockquote>
<p>Controller methods (also known as action methods), generally return an ActionResult (or a class derived from ActionResult).</p>
</blockquote>

<p>Controller methods often return <code class="prettyprint">View()</code>, which specified that the method should use a view template file to render a response to the browser. When the name of the view template to use isn&rsquo;t explicitly specified, ASP.NET MVC defaults to using the view file sharing the name of the action method. </p>

<p>ASP.NET controller scaffolding will create <code class="prettyprint">Create</code> action methods for both GET and POST requests.</p>

<p>But what about if you want to bulk create items?</p>

<p>First of all, we need to change the arguments that are passed to the POST request. Instead of </p>
<pre class="highlight csharp tab-csharp"><code><span class="na">[HttpPost]</span>
<span class="na">[ValidateAntiForgeryToken]</span>
<span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Equipment</span> <span class="n">equipment</span><span class="p">)</span>
</code></pre>
<p>We need to pass the method an <code class="prettyprint">IEnumerable</code> object instead of a single object.</p>
<pre class="highlight csharp tab-csharp"><code><span class="na">[HttpPost]</span>
<span class="na">[ValidateAntiForgeryToken]</span>
<span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Equipment</span><span class="p">&gt;</span> <span class="n">equipmentCollection</span><span class="p">)</span>
</code></pre>
<blockquote>
<p>Usually what you choose will depend on which methods you need access to. In general:
- <code class="prettyprint">IEnumerable&lt;&gt;</code> for a list of objects that only needs to be iterated through.
- <code class="prettyprint">ICollection&lt;&gt;</code> for a list of objects that needs to be iterated through and modified.
- <code class="prettyprint">List&lt;&gt;</code> for a list of objects that needs to be iterated through, modified, sorted, etc.</p>
</blockquote>

<h2 id="using-dbcontext-in-controllers">Using DbContext in Controllers</h2>

<p>First of all, to access the database, instantiate a instance of the database:</p>
<pre class="highlight csharp tab-csharp"><code><span class="k">private</span> <span class="n">ProjectContext</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProjectContext</span><span class="p">();</span>
</code></pre>
<h3 id="getting-a-list-of-all-an-entitys-elements">Getting a list of all an entity&rsquo;s elements</h3>
<pre class="highlight csharp tab-csharp"><code><span class="kt">var</span> <span class="n">equipments</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Equipments</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Student</span><span class="p">);</span>
<span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">equipments</span><span class="p">);</span>
</code></pre>
<h3 id="finding-a-single-entity-entry">Finding a single entity entry</h3>
<pre class="highlight csharp tab-csharp"><code><span class="n">Equipment</span> <span class="n">equipment</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Equipments</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">equipment</span><span class="p">);</span>
</code></pre>
<h3 id="updating-a-single-entry">Updating a single entry</h3>
<pre class="highlight csharp tab-csharp"><code><span class="n">db</span><span class="p">.</span><span class="nf">Entry</span><span class="p">(</span><span class="n">equipment</span><span class="p">).</span><span class="n">State</span> <span class="p">=</span> <span class="n">EntityState</span><span class="p">.</span><span class="n">Modified</span><span class="p">;</span>
<span class="n">db</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
</code></pre>
<h3 id="updating-a-single-field-in-an-entry">Updating a single field in an entry</h3>
<pre class="highlight csharp tab-csharp"><code><span class="n">Equipment</span> <span class="n">equipment</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Equipments</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span>
<span class="n">equipment</span><span class="p">.</span><span class="n">StudentID</span> <span class="p">=</span> <span class="n">StudentID</span><span class="p">;</span>
<span class="n">db</span><span class="p">.</span><span class="nf">Entry</span><span class="p">(</span><span class="n">equipment</span><span class="p">).</span><span class="n">State</span> <span class="p">=</span> <span class="n">EntityState</span><span class="p">.</span><span class="n">Modified</span><span class="p">;</span>
<span class="n">db</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
</code></pre>
<h3 id="deleting-an-entry">Deleting an entry</h3>
<pre class="highlight csharp tab-csharp"><code><span class="n">Equipment</span> <span class="n">equipment</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Equipments</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="n">db</span><span class="p">.</span><span class="n">Equipments</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">equipment</span><span class="p">);</span>
<span class="n">db</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
</code></pre>
  </div>
  <div class="dark-box">
  </div>
</div>
  </body>
</html>
